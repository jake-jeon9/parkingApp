<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.parkinglistMapper">
	<!-- 주차 리스트 -->
	<!-- 차량 입차 -->
	<insert id="parkinglistInsert" parameterType="parkinglistDTO" useGeneratedKeys="true" keyColumn="usedNo,memberNo,timeOfParked,currentOfState" keyProperty="usedNo,memberNo,timeOfParked,currentOfState">
		INSERT INTO listOfparked 
		VALUES     (seq_listOfParked.nextval,
		           #{memberNo},
				   #{plateNumOfCar},
				   default,
				   0,
				   sysdate,
				   null,
				   0,
				   null
				   )
	</insert>
	<!-- 차량 출차 -->
	<update id="parkinglistUpdate" parameterType="parkinglistDTO" >
		UPDATE listOfparked 
		SET    currentOfState = #{currentOfState}, 
			   timeOfused = to_data(#{timeOfused}),
			   timeOfOut = sysdate,
			   paid = #{paid},
			   coupon = #{coupon}
		WHERE  usedNo = #{usedNo} and currentOfState = 'in'
	</update>
	
	<!-- 정보수정 -->
	<update id="parkinglistModify" parameterType="parkinglistDTO" >
		UPDATE listOfparked 
		SET    plateNumOfCar = #{plateNumOfCar}, 
			   currentOfState=#{currentOfState},
			   timeOfused=#{timeOfused},
			   timeOfOut=#{timeOfOut},
			   timeOfParked=#{timeOfParked},
			   paid=#{paid},
			   coupon=#{coupon},
		WHERE  usedNo = #{usedNo} 
	</update>
	
	<!-- 리스트 삭제 -->
	<delete id="parkinglistDelete" parameterType="int" >
		DELETE FROM listOfparked 
		WHERE  usedNo = #{usedNo}
	</delete>
	
	<!-- 특정 차량 조회 -->
	<select id = "getSpacificitem" parameterType="java.util.Map" resultType="parkinglistDTO">
		SELECT * FROM listofparked
		WHERE memberNo = #{memberNo} and platenumofcar = #{platenumofcar}
	</select>
	
	<!-- 오늘 차량 리스트 조회  option : in or out and coupon true-->
	<select id = "getTodayAll" parameterType="java.util.Map" resultType="parkinglistDTO">
		SELECT * FROM listofparked
		WHERE memberNo = #{memberNo} and timeOfParked = sysdate
		 <if test="state == 1"> 
		  and currentofstate = 'in'
		 </if>
		 <if test="state == 2"> 
		  and currentofstate = 'out'
		 </if>
		 <if test="coupon.equals(true)"> 
		  and coupon = 'true'
		 </if>
	</select>

	<!-- 페이징 기간 조회  option : 1. in or out 2. coupon true -->
	<select id = "parkinglistSelect" parameterType="java.util.Map" resultType="parkinglistDTO">
		<![CDATA[
		SELECT usedNo,memberNo,plateNumOfCar,currentOfState,timeOfused,timeOfParked,timeOfOut,paid,coupon 
			FROM ( SELECT rownum rn, tt. * 
				FROM( SELECT * FROM listofparked
						 WHERE memberNo = #{memberNo} 
							<if test = "startDate != null">
								 AND timeOfParked BETWEEN
								  #{startDate} AND #{endDate}
		 						<if test="coupon.equals(true)"> 
		  							 and coupon = #{coupon}'
		 						</if>
		 					</if>
		 				ORDER BY usedNo DESC nulls last)
		 		 tt)
		 	WHERE rn>= #{startNum} and rn<= #{endNum}		 				
		 ]]> 
	</select>
	
	
</mapper>